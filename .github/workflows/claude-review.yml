name: Claude AI Review

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  claude-review:
    if: |
      github.event.issue.pull_request && 
      contains(tolower(github.event.comment.body), '@claude') && 
      contains(tolower(github.event.comment.body), '/review') && 
      github.event.comment.user.type != 'Bot' && 
      contains('OWNER,MEMBER,COLLABORATOR', github.event.comment.author_association) &&
      vars.CLAUDE_ENABLED == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: claude-review-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@v2
      with:
        disable-sudo: true
        egress-policy: block
        allowed-endpoints: >
          api.github.com:443
          github.com:443
          api.anthropic.com:443

    - name: Checkout PR
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Simulate Claude Code Review (Smoke Test)
      run: |
        echo "ü§ñ Simulating Claude AI Review..."
        
        # Check path restrictions
        if echo "${{ github.event.comment.body }}" | grep -i "workflow\|\.env\|release"; then
          echo "‚ùå Request violates path restrictions"
          exit 1
        fi
        
        # Simulate AI review comment
        gh pr comment ${{ github.event.pull_request.number }} --body "$(cat <<'EOF'
        ## ü§ñ AI Review (Advisory)
        
        **Documentation Update Analysis:**
        
        ‚úÖ **Change Quality**: Minor documentation enhancement adding testing notes
        ‚úÖ **CLAUDE.md Structure**: Maintains existing format and conventions
        ‚úÖ **Content Accuracy**: Testing notes are factual and helpful
        ‚úÖ **No Issues Found**: Clean documentation update with no concerns
        
        **Recommendations:**
        - Documentation change looks good
        - No security or quality concerns
        - Maintains consistency with existing docs
        
        > This review is advisory only. Human review and existing quality gates (doctor/tsc/e2e) remain authoritative.
        
        **Integration**: Results appended to [doctor report artifacts](../artifacts/doctor-report.md)
        
        **‚ö†Ô∏è SIMULATION**: This is a smoke test simulation of the actual Claude review workflow.
        EOF
        )"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Capture Metrics & Append to Doctor Report
      if: always()
      run: |
        mkdir -p artifacts
        TRIGGER_TIME="${{ github.event.comment.created_at }}"
        RESPONSE_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        echo "" >> artifacts/doctor-report.md
        echo "## ü§ñ AI Review (Advisory)" >> artifacts/doctor-report.md
        echo "" >> artifacts/doctor-report.md
        echo "**Generated:** $RESPONSE_TIME" >> artifacts/doctor-report.md
        echo "**PR:** #${{ github.event.pull_request.number }}" >> artifacts/doctor-report.md
        echo "**Trigger:** @claude /review" >> artifacts/doctor-report.md
        echo "**Comment Time:** $TRIGGER_TIME" >> artifacts/doctor-report.md
        echo "" >> artifacts/doctor-report.md
        echo "### üìä Metrics" >> artifacts/doctor-report.md
        echo "- **Triggered:** $TRIGGER_TIME" >> artifacts/doctor-report.md  
        echo "- **Completed:** $RESPONSE_TIME" >> artifacts/doctor-report.md
        echo "- **Signal Quality:** ‚ö†Ô∏è _Tag as ‚úÖ useful / ‚ö†Ô∏è noisy in PR comments_" >> artifacts/doctor-report.md
        echo "" >> artifacts/doctor-report.md
        echo "> AI review completed. See PR comments for detailed feedback." >> artifacts/doctor-report.md
        echo "> This is advisory only - human review and quality gates remain authoritative." >> artifacts/doctor-report.md
        
    - name: Apply AI Review Label
      if: success()
      run: |
        gh pr edit ${{ github.event.pull_request.number }} --add-label "ai-review:advisory"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload Doctor Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: doctor-report-claude-review
        path: artifacts/
        retention-days: 30